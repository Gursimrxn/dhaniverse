<!DOCTYPE html>
<html>
<head>
    <title>Chat Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin: 10px 0; }
        #messageInput { width: 300px; padding: 5px; }
        button { padding: 5px 10px; margin: 5px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .message { margin: 5px 0; }
        .username { font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>WebSocket Chat Test</h1>
    
    <div id="status" class="status disconnected">Disconnected</div>
    
    <div>
        <input type="text" id="usernameInput" placeholder="Enter username" value="TestUser">
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <div id="messages"></div>
    
    <div>
        <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)">
        <button onclick="sendMessage()">Send</button>
    </div>

    <script>
        let ws = null;
        let connected = false;
        let authenticated = false;

        function updateStatus(message, isConnected) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
            connected = isConnected;
        }

        function addMessage(username, message, isSystem = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            if (isSystem) {
                messageDiv.innerHTML = `<em style="color: #666;">${message}</em>`;
            } else {
                messageDiv.innerHTML = `<span class="username">${username}:</span> ${message}`;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function connect() {
            const username = document.getElementById('usernameInput').value.trim();
            if (!username) {
                alert('Please enter a username');
                return;
            }

            if (ws) {
                ws.close();
            }

            updateStatus('Connecting...', false);
            addMessage('System', 'Attempting to connect...', true);

            ws = new WebSocket('ws://localhost:8001');

            ws.onopen = () => {
                updateStatus('Connected, authenticating...', false);
                addMessage('System', 'Connected to WebSocket server', true);
                
                // Send authentication (using a dummy token for testing)
                const authMessage = {
                    type: 'authenticate',
                    token: 'dummy-token-for-testing',
                    gameUsername: username
                };
                
                console.log('Sending auth message:', authMessage);
                ws.send(JSON.stringify(authMessage));
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('Received message:', data);

                    switch (data.type) {
                        case 'connect':
                            authenticated = true;
                            updateStatus(`Connected as ${username}`, true);
                            addMessage('System', `Authenticated successfully as ${username}`, true);
                            break;

                        case 'chat':
                            addMessage(data.username, data.message);
                            break;

                        case 'error':
                            addMessage('System', `Error: ${data.message}`, true);
                            if (data.error === 'authentication_failed') {
                                updateStatus('Authentication failed', false);
                            }
                            break;

                        case 'players':
                            addMessage('System', `${data.players.length} other players online`, true);
                            break;

                        case 'playerJoined':
                            addMessage('System', `${data.player.username} joined the game`, true);
                            break;

                        case 'playerDisconnect':
                            addMessage('System', `${data.username} left the game`, true);
                            break;

                        default:
                            console.log('Unknown message type:', data.type);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                    addMessage('System', 'Error parsing server message', true);
                }
            };

            ws.onclose = (event) => {
                authenticated = false;
                updateStatus('Disconnected', false);
                addMessage('System', `Connection closed: ${event.reason || 'Unknown reason'}`, true);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addMessage('System', 'WebSocket error occurred', true);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                return;
            }

            if (!ws || !connected || !authenticated) {
                addMessage('System', 'Not connected or authenticated', true);
                return;
            }

            const chatMessage = {
                type: 'chat',
                message: message
            };

            console.log('Sending chat message:', chatMessage);
            ws.send(JSON.stringify(chatMessage));
            messageInput.value = '';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Auto-connect on page load for testing
        window.onload = () => {
            // Uncomment the line below to auto-connect for testing
            // connect();
        };
    </script>
</body>
</html>